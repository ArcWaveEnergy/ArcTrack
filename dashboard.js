function isoWeek(d){const date=new Date(d);const dayNum=(date.getUTCDay()+6)%7;date.setUTCDate(date.getUTCDate()-dayNum+3);const firstThursday=new Date(Date.UTC(date.getUTCFullYear(),0,4));const week=1+Math.round(((date-firstThursday)/86400000-3+((firstThursday.getUTCDay()+6)%7))/7);return `${date.getUTCFullYear()}-W${String(week).padStart(2,'0')}`;}
async function loadSummary(){const [timeRecs,milesRecs,hotelRecs,partRecs]=await Promise.all([getAll('time'),getAll('mileage'),getAll('hotels'),getAll('parts')]);const agg={};timeRecs.forEach(t=>{const w=t.date?isoWeek(t.date):'n/a';agg[w]=agg[w]||{reg:0,ot:0,miles:0,hotel:0,parts:0};agg[w].reg+=+t.reg||0;agg[w].ot+=+t.ot||0;});milesRecs.forEach(m=>{const w='n/a';agg[w]=agg[w]||{reg:0,ot:0,miles:0,hotel:0,parts:0};agg[w].miles+=+m.miles||0;});hotelRecs.forEach(h=>{const w='n/a';agg[w]=agg[w]||{reg:0,ot:0,miles:0,hotel:0,parts:0};agg[w].hotel+=+h.cost||0;});partRecs.forEach(p=>{const w='n/a';agg[w]=agg[w]||{reg:0,ot:0,miles:0,hotel:0,parts:0};agg[w].parts+=+p.cost||0;});const tbody=document.getElementById('summaryBody');tbody.innerHTML='';Object.entries(agg).forEach(([w,v])=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${w}</td><td>${v.reg.toFixed(2)}</td><td>${v.ot.toFixed(2)}</td><td>${v.miles.toFixed(1)}</td><td>$${v.hotel.toFixed(2)}</td><td>$${v.parts.toFixed(2)}</td>`;tbody.appendChild(tr);});}
loadSummary();